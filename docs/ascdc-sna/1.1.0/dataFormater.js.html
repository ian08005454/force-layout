<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>dataFormater.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="module-keywordCleaner-searchTarget.html">searchTarget</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="searchWord.html">searchWord</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="searchWord.html#.keywordCleanUp">keywordCleanUp</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="searchWord.html#.keywordNot">keywordNot</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="searchWord.html#.lineAppend">lineAppend</a></span></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-API.html">API</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-API.html#.GetJSON">GetJSON</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-assignColor.html">assignColor</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-chartSetting.html">chartSetting</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-colorPanelSetting.html">colorPanelSetting</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-colorPanelSetting.html#.colorPanelInit">colorPanelInit</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-dataFormater.html">dataFormater</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-dataFormater.html#~appendNode">appendNode</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-dataFormater.html#~dataFormat">dataFormat</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-dataFormater.html#~getRandomColor">getRandomColor</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-dataFormater.html#~hslToHex">hslToHex</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-dataFormater.html#~setSquare">setSquare</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-graphologyLayoutSystem.html">graphologyLayoutSystem</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-graphologyLayoutSystem.html#.layoutCalculator">layoutCalculator</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-graphologyLayoutSystem.html#~dataTypeChange">dataTypeChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-graphologyLayoutSystem.html#~positionWrite">positionWrite</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-keywordCleaner.html">keywordCleaner</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-keywordCleaner.html#.keywordCleanUp">keywordCleanUp</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-keywordCleaner.html#.keywordItemAppend">keywordItemAppend</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-keywordCleaner.html#~keyword_item_delete">keyword_item_delete</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-keywordCleaner.html#~lineCtrl">lineCtrl</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-listGenerator.html">listGenerator</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-listGenerator.html#.listGenerator">listGenerator</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-listGenerator.html#~lineList">lineList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-listGenerator.html#~lineListChange">lineListChange</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-listGenerator.html#~nodeList">nodeList</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-listGenerator.html#~nodeListChange">nodeListChange</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-MainSetting.html">MainSetting</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-MainSetting.html#.event_setOption_function">event_setOption_function</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-MainSetting.html#.keywordFliter">keywordFliter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-MainSetting.html#.lineColorChanger">lineColorChanger</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-MainSetting.html#~edgeFilter">edgeFilter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-MainSetting.html#~keyword_search">keyword_search</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-MainSetting.html#~max_Level">max_Level</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-MainSetting.html#~resetChart">resetChart</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-MainSetting.html#~viewDataChange">viewDataChange</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-searchFunction.html">searchFunction</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-searchFunction.html#.changeMaxlevel">changeMaxlevel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-searchFunction.html#.searchKeyword">searchKeyword</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-searchFunction.html#~andSearch">andSearch</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-searchFunction.html#~andSearchNoRoute">andSearchNoRoute</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-searchFunction.html#~data_filter">data_filter</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-searchFunction.html#~dataAppendOr">dataAppendOr</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-searchFunction.html#~floodingSearch">floodingSearch</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-searchFunction.html#~lineOr">lineOr</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-sliderbarSetting.html">sliderbarSetting</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-sliderbarSetting.html#.positionCalculator">positionCalculator</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-sliderbarSetting.html#.silderInit">silderInit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-sliderbarSetting.html#.sliderBar">sliderBar</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-sliderbarSetting.html#~centrality">centrality</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-sliderbarSetting.html#~filterControler">filterControler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-sliderbarSetting.html#~ngraph">ngraph</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-sliderbarSetting.html#~switchType">switchType</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">dataFormater.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module dataFormater
 * @description 資料格式轉換模組
 * @author Wei-Jie Li
 * @createDate 2021-03-21
 * @exports dataFormat
 */
import { SetLineColor } from "./assignColor";
var lineColors = {};
var buf = {
	//暫存資料用
	nodes: [],
	all_nodes: [],
	links: [],
	category: [],
	all_category: []
};
var allValues = [];
var allIdf = [];
// var userColors = ["#cc0000", "#00cc00", "#0000cc"];
// var userColors = [];
var id = 0;
/**
 * 將節點加入資料集陣列
 * @param {object} data_element - 物件json檔
 * @param {string} name - 別點名字
 * @param {string} bType - 形狀類型
 * @param {string} bColor - 邊界顏色
 * @param {number} bWidth - 邊界寬度
 */
function appendNode(data_element, name, bType = 'solid', bColor = 'gray', bWidth = 0) {
	if (data_element.idf === 0) {
		var lenghValue = 1;
	} else lenghValue = data_element.idf;
	if (userColors.hasOwnProperty(data_element.gp)) {
		var nodeColor = userColors[data_element.gp];
	} else {
		var nodeColor = getRandomColor(); //calculate_color
		userColors[data_element.gp] = nodeColor;
	}
	buf.nodes.push({
		name: name,
		gp: data_element.gp,
		idf: data_element.idf,
		symbolSize: 30 * Math.sqrt(Math.sqrt(lenghValue, 3) / 0.8),
		originalSymbolSize: 30 * Math.sqrt(Math.sqrt(lenghValue, 3) / 0.8),
		value: data_element.idf, //data_element.idf,
		symbol: 'circle',
		itemStyle: {
			opacity: 0.9, //work
			borderType: bType, //'solid',
			borderColor: bColor, //'orange',
			borderWidth: bWidth, //css_ele.borderWidth,  //0,
			color: nodeColor
		}
	});
}
/**
 * 以資料的最大值設定平方數
 * @param {number} largest - 全部資料的最大數值 
 * @returns {number} 平方數
 */
function setSquare(largest){
	if (largest > 4096) var square = 4;
	else if (largest > 256) var square = 3;
	else if (largest > 16) var square = 2;
	else var square = 1;
	return square;
}
/**
 * 將jason資料轉換成echarts的資料格式
 * @param {json} data - json資料 
 * @returns {object} 轉換後的資料
 */
function dataFormat(data) {
	const set = new Set(); //為了之後去除重複
	data.forEach((data_element) => {
		allIdf.push(data_element.idf);
		if (data_element.idf === 0) appendNode(data_element, data_element.k1, 'solid', '#ffb61e', 3);
		else appendNode(data_element, data_element.k1);
		var largest = data_element.kg2[0].v;
		data_element.kg2.forEach((kg2Element) => {
			if (kg2Element.v > largest) largest = kg2Element.v;
		});
		var square = setSquare(largest);
		// foreach kg2 array
		data_element.kg2.forEach((kg2_element) => {
			// random a new color without duplicate, this color will according with category color to pair link color
			if (lineColors.hasOwnProperty(kg2_element.type[0])) {
				var lineColor = lineColors[kg2_element.type[0]].color;
			} else {
				// let name = kg2_element.type[0];
				var lineColor = '#1A75CF'; //calculate_color getRandomColor()
				lineColors[kg2_element.type[0]] = {color:lineColor, group:[]};
				for (let index = 0; index &lt; userColors.length; index++) {
					lineColors[kg2_element.type[0]].group.push(0);
				}
			}
			if(kg2_element.gp !== data_element.gp){
				lineColors[kg2_element.type[0]].group[kg2_element.gp]++;
				lineColors[kg2_element.type[0]].group[data_element.gp]++;
			}
			if (dataType === 1) {
				lineColor = '#1A75CF';
			}
			allIdf.push(kg2_element.idf);
			// first : push k2 into nodes array, ignore duplicate problem e.g.AB互為兄弟時 會產生重複兩個節點
			if (kg2_element.idf == 0) appendNode(kg2_element, kg2_element.k2, 'solid', '#ffb61e', 3);
			else appendNode(kg2_element, kg2_element.k2);
			// second : push all category into buf.category array, ignore duplicate problem
			allValues.push(kg2_element.v);
			if (kg2_element.v == 0) {
				var dash = 'dashed';
				var ttype = dash;
			} else {
				var linksolid = 'solid';
				var ttype = linksolid;
			}
			if (kg2_element.type[0] == '未定義' || kg2_element.type[0] == '') {
				if (dataType !== 1) {
					kg2_element.type[0] = '未定義';
					lineColor = 'black';
					var shadowBlur = 10;
				}
			} else var shadowBlur = 0;
			if (kg2_element.v === 0) {
				var lenghValue = 1;
			} else if (dataType === 2) {
				var lenghValue = 5;
			} else lenghValue = kg2_element.v;
			buf.all_category.push({
				id: id++,
				name: kg2_element.type[0],
				target: data_element.k1,
				source: kg2_element.k2,
				value: kg2_element.v,
				show: true, //是否要顯示於畫面上
				bilateral: 'false',
				force: {
					edgeLength: Math.sqrt(lenghValue, square) * 10000000
				},
				lineStyle: {
					opacity: 1, //work
					color: lineColor,
					// curveness: 0.4, //原1 / Math.sqrt(kg2_element.v, 2) //曲度
					width: Math.sqrt(lenghValue, square),
					originalWidth: Math.sqrt(lenghValue, square),
					type: ttype, //kg2_element.css[0].linetype  //'dashed'
					shadowColor: 'orange',
					shadowBlur: shadowBlur
				},
				label: {
					show: true,
					color: lineColor
				}
			});
			// buf.all_category has the every property that links object need, etc : source, target, value, lineStyle
			buf.links = buf.all_category;
		});
	});
	buf.all_category.sort(function(a, b) {
		if (a.id &lt; b.id) {
			return -1;
		}
		if (a.id > b.id) {
			return 1;
		}
		return 0;
	});
	console.log(buf.all_category);
	// remove duplicate item in buf.nodes array
	buf.nodes = buf.nodes.filter((item) => (!set.has(item.name) ? set.add(item.name) : false));
	set.clear();

	// push all node into all_nodes to determine keyword search
	buf.nodes.forEach((node) => {
		buf.all_nodes.push(node.name);
	});

	// sort buf.all_category
	buf.all_category = buf.all_category.sort((a, b) => {
		return a.name > b.name ? 1 : -1;
	});
	buf.all_category.forEach(category =>{
		buf.all_category.forEach(item =>{
			if(item.target === category.source &amp;&amp; item.source === category.target){
				if(item.name === category.name &amp;&amp; category.bilateral !== 'delete'){
					category.bilateral = 'true';
					item.bilateral  = 'delete';
				}
			}
		})
	});
	var colorList = Object.keys(lineColors);
	console.log(lineColors);
	lineColors = SetLineColor(colorList, lineColors, userColors);
	buf.all_category.forEach(category =>{
		category.lineStyle.color = lineColors[category.name].color;
		category.label.color = lineColors[category.name].color;
	})
	buf.category = buf.all_category;
	return buf;
}
// set each data color a random hex color
// function calculate_color() {
//     return '#' + (Math.random() * 0xFFFFFF &lt;&lt; 0).toString(16);//&lt;&lt;=左移賦值
// }
/**
 * 
 * @see 參考資料{@link https://segmentfault.com/q/1010000010807637/a-1020000010809153 }
 * @returns {string} 所選的HEX顏色代碼
 */
function getRandomColor() {
	var hslLength = HSL.length;
	var ret = [];
	ret[0] = Math.floor(Math.random() * 360);
	if (HSL.length > 36) {
		ret[1] = 80;
		ret[2] = 70;
	} else {
		ret[1] = 70;
		ret[2] = 50;
	}

	for (var i = 0; i &lt; hslLength; i++) {
		// 色相差異調整
		if (i > 0 &amp;&amp; Math.abs(ret[0] - HSL[i][0]) &lt; 8) {
			ret[0] = Math.floor(Math.random() * 360);
			// ret[1]= Math.floor(Math.random() * 100);
			// ret[2]= Math.floor(Math.random() * 100);
			i = 0;
		}
	}
	// ret[1] = 70 + (ret[1] * 0.3); // [0.7 - 0.9] 排除过灰颜色
	// ret[2] = 40 + (ret[2] * 0.4); // [0.4 - 0.8] 排除过亮过暗色

	// 数据转化到小数点后两位
	ret = ret.map(function(item) {
		return parseFloat(item.toFixed(2));
	});

	HSL.push(ret[0]);
	// console.log(ret);
	var color = hslToHex(ret[0], ret[1], ret[2]);
	// console.log(color);
	return color;
}
/**
 *將HSL顏色格式代碼轉成HEX格式代碼 
 * @param {number} h 色相
 * @param {number} s 飽和度
 * @param {number} l 亮度
 * @returns {string} HEX color code
 * @see 參考資料 {@link https://stackoverflow.com/questions/36721830/convert-hsl-to-rgb-and-hex}
 * @see 參考資料 {@link https://www.ginifab.com.tw/tools/colors/rgb_to_hsv_hsl.html}
 */
function hslToHex(h, s, l) {
	h /= 360;
	s /= 100;
	l /= 100;
	let r, g, b;
	if (s === 0) {
		r = g = b = l; // achromatic
	} else {
		const hue2rgb = (p, q, t) => {
			if (t &lt; 0) t += 1;
			if (t > 1) t -= 1;
			if (t &lt; 1 / 6) return p + (q - p) * 6 * t;
			if (t &lt; 1 / 2) return q;
			if (t &lt; 2 / 3) return p + (q - p) * (2 / 3 - t) * 6;
			return p;
		};
		const q = l &lt; 0.5 ? l * (1 + s) : l + s - l * s;
		const p = 2 * l - q;
		r = hue2rgb(p, q, h + 1 / 3);
		g = hue2rgb(p, q, h);
		b = hue2rgb(p, q, h - 1 / 3);
	}
	const toHex = (x) => {
		const hex = Math.round(x * 255).toString(16);
		return hex.length === 1 ? '0' + hex : hex;
	};
	return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
}
export { dataFormat, allValues, allIdf };
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Fri Jul 02 2021 02:42:01 GMT+0800 (台北標準時間) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
